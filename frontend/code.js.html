<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/0.3.0/js/ripples.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/0.3.0/js/material.min.js"></script>

<script>
    console.log('--BEGIN--');  //do NOT remove, to find the proper script in Dev Tools

    function alterPrefixedClass(jq, prefix, newValue){
        var cls = jq.attr('class');
        jq.attr('class', 
                cls.replace(new RegExp(prefix + '\\w+', 'g'), prefix + newValue)
        );
    }
    
    function Notifier(flashContainerSelector, flashSelector, flashStylePrefix, spinnerOverlaySelector, successTimeout) {
        var t = this;
        t._flashContainer = $(flashContainerSelector);
        t._flashOrig = $(flashSelector);
        t._styleClassPrefix = flashStylePrefix;
        t._spinner = $(spinnerOverlaySelector);
        t._successTimeout = successTimeout;
    }

    Notifier.ERROR = 'warning';
    Notifier.INFO = 'info';
    Notifier.SUCCESS = 'success';
    
    
    Notifier.prototype.flash = function (messageType, title, message) {
        var t = this;
        var flash = t._flashOrig.clone();
        alterPrefixedClass(flash, t._styleClassPrefix, messageType);
        flash.find('.flash_text').text(message);
        flash.find('.flash_title').text(title);
        t._flashContainer.append(flash);
        flash.show();
        if (t._successTimeout){
            setTimeout(function () {
                        flash.remove();
                }, t._successTimeout
            )
        }
    }

    Notifier.prototype.clearFlash = function () {
        var t = this;
        t._flashContainer.empty();
    }
    
    Notifier.prototype.busy = function (isBusy) {
        var t = this;
        t._spinner[isBusy ? 'show' : 'hide']();
    }
    
    var notifier = new Notifier('#flash-container', '#flash-message', 'alert-', '#spinner-overlay', 4000);
    
    
    function onSuccessWrapper(result, env) {
        if (!result) return; //this is a callback NOT from business logic endpoints, like UI dialog...

        notifier.flash(Notifier.SUCCESS, 'Success', 'DONE!');
        notifier.busy(false);
        
        if (env.callback) env.callback(result);
    }

    function onErrorWrapper(error, env) {
        var er = formatError(error);
        notifier.flash(Notifier.ERROR, er.title, er.message);
        notifier.busy(false);
    }

    var runner = google.script.run
            .withSuccessHandler(onSuccessWrapper)
            .withFailureHandler(onErrorWrapper);
    
    
    function makeActionHandler(entity, operation, actionParams, env) {
        env = env || {};
        return function() {
            callAction(entity, operation, actionParams, env);
        }
    }

    function callAction(entity, operation, actionParams, env) {
        env = env || {};
        console.log("action handler called.");
        notifier.clearFlash();
        notifier.busy(true);

        runner.withUserObject(env).runAction(entity, operation, actionParams);
    }

    function formatError(error) {
        if (typeof error === 'string') {
            return {title: 'Error', message: error};
        } else {
            var errInfo = "";
            for (var prop in error) {
                errInfo += prop + ": " + error[prop] + "<br />";
            }
            return {title: error.name, message: errInfo};
        }
    }

    /**
     * Run initializations on web app load.
     */
    $(function () {
        /**
         * This is a clever trick to redirect whole browser window
         * and not only Apps Script's iFrame sandbox
         * Needs only to touch full links (beginning with http)
         * other links may be just service links like Dropdown etc
         */
        $('a[href^="http"]').on('click', function (event) {
            event.preventDefault();
            window.top.location.href = $(this).attr('href');
        });

        // Call the server here to retrieve any information needed to build the page.
        $.material.init();

//      $('#runMonthlyCustomReport button').click(makeActionHandler(
//              'runMonthlyCustomReport', 
//              {
//                  message: INITIAL_MESSAGE,
//              },
//              CONFIG.VALIDATIONS.MONTHS_NUMBER
//      ));

//      $('#cancel').click(function(){ 
//          cancel = true;
//          $('#message').text('Rest of tasks cancelled, current one is finishing...');
//          $('#cancel').hide();
//      });
    });

</script>
